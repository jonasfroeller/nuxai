<script lang="ts" setup>
import type { Message } from '@ai-sdk/vue';
import CopyToClipboard from '~/components/utils/CopyToClipboard.vue';
import { render } from 'vue';

defineProps<{
  messages: Message[];
}>();

const useSsrSaveId = () => useId();
const $messagesList = ref<HTMLElement | null>(null);

// adds "copy code" button to each code block
onMounted(() => {
  if ($messagesList.value) {
    useMutationObserver(
      $messagesList.value,
      (mutations) => {
        const shikiElement = $messagesList.value?.querySelectorAll('.shiki');
        // console.log('shikiElement', shikiElement);

        if (shikiElement) {
          // pre tag with class="language-<some-language> shiki"
          for (const codeBlock of shikiElement) {
            if (!codeBlock.classList.contains('relative')) {
              codeBlock.classList.add('relative');

              // creates a Vue component instance
              const copyComponent = h(CopyToClipboard, {
                class: 'absolute top-2 right-2',
                text: codeBlock.textContent ?? 'NO CODE', // TODO: parse mime type out of className language-<some-language> and validate it => else text
              });

              render(copyComponent, codeBlock);
            }
          }
        }
      },
      {
        childList: true,
        subtree: true,
      }
    );
  }
});
</script>

<template>
  <div ref="$messagesList">
    <AiChatMessage
      :key="useSsrSaveId"
      v-for="message in messages"
      :message="message"
    />
  </div>
</template>

<style scoped></style>
